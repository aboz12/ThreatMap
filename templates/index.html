<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-Time Internet Threat Map</title>
    <script src="https://unpkg.com/globe.gl@2.27.0/dist/globe.gl.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0a0a1a;
            color: #fff;
            overflow: hidden;
            height: 100vh;
        }

        #globe-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        .overlay {
            position: absolute;
            z-index: 10;
            pointer-events: none;
        }

        .overlay > * {
            pointer-events: auto;
        }

        /* Header */
        .header {
            top: 0;
            left: 0;
            right: 0;
            padding: 20px 30px;
            background: linear-gradient(180deg, rgba(10,10,26,0.95) 0%, rgba(10,10,26,0) 100%);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .title {
            font-size: 24px;
            font-weight: 600;
            text-shadow: 0 0 20px rgba(0, 200, 255, 0.5);
        }

        .title span {
            color: #00c8ff;
        }

        .live-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #0f0;
        }

        .feed-status {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 12px;
            color: #888;
        }

        .feed-badge {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 4px 10px;
            background: rgba(0, 200, 255, 0.1);
            border: 1px solid rgba(0, 200, 255, 0.3);
            border-radius: 12px;
        }

        .feed-badge.active {
            background: rgba(0, 255, 0, 0.1);
            border-color: rgba(0, 255, 0, 0.3);
            color: #0f0;
        }

        .feed-count {
            font-weight: 600;
            color: #00c8ff;
        }

        .live-dot {
            width: 10px;
            height: 10px;
            background: #0f0;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; box-shadow: 0 0 10px #0f0; }
            50% { opacity: 0.5; box-shadow: 0 0 20px #0f0; }
        }

        /* Stats Panel */
        .stats-panel {
            top: 80px;
            left: 20px;
            width: 280px;
            background: rgba(10, 20, 40, 0.85);
            border: 1px solid rgba(0, 200, 255, 0.3);
            border-radius: 12px;
            padding: 20px;
            backdrop-filter: blur(10px);
        }

        .stats-title {
            font-size: 14px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 15px;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .stat-row:last-child {
            border-bottom: none;
        }

        .stat-label {
            color: #aaa;
            font-size: 13px;
        }

        .stat-value {
            font-size: 18px;
            font-weight: 600;
            color: #00c8ff;
        }

        .stat-value.critical {
            color: #ff4444;
        }

        /* Threat Types Legend */
        .legend-panel {
            bottom: 20px;
            left: 20px;
            width: 280px;
            background: rgba(10, 20, 40, 0.85);
            border: 1px solid rgba(0, 200, 255, 0.3);
            border-radius: 12px;
            padding: 20px;
            backdrop-filter: blur(10px);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 6px 0;
            font-size: 12px;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            box-shadow: 0 0 8px currentColor;
        }

        .legend-count {
            margin-left: auto;
            color: #666;
            font-size: 11px;
        }

        /* Attack Feed */
        .feed-panel {
            top: 80px;
            right: 20px;
            width: 350px;
            max-height: calc(100vh - 120px);
            background: rgba(10, 20, 40, 0.85);
            border: 1px solid rgba(0, 200, 255, 0.3);
            border-radius: 12px;
            backdrop-filter: blur(10px);
            overflow: hidden;
        }

        .feed-header {
            padding: 15px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            font-size: 14px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .feed-list {
            max-height: calc(100vh - 200px);
            overflow-y: auto;
            padding: 10px;
        }

        .feed-list::-webkit-scrollbar {
            width: 6px;
        }

        .feed-list::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.05);
        }

        .feed-list::-webkit-scrollbar-thumb {
            background: rgba(0, 200, 255, 0.3);
            border-radius: 3px;
        }

        .attack-item {
            background: rgba(255,255,255,0.03);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            border-left: 3px solid var(--attack-color);
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .attack-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .attack-type {
            font-weight: 600;
            font-size: 13px;
            color: var(--attack-color);
        }

        .attack-time {
            font-size: 11px;
            color: #666;
        }

        .attack-route {
            font-size: 12px;
            color: #aaa;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .attack-route .arrow {
            color: var(--attack-color);
        }

        .attack-details {
            font-size: 11px;
            color: #666;
            margin-top: 6px;
        }

        .severity-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .severity-critical {
            background: rgba(255, 0, 0, 0.2);
            color: #ff4444;
        }

        .severity-high {
            background: rgba(255, 136, 0, 0.2);
            color: #ff8800;
        }

        .severity-medium {
            background: rgba(255, 255, 0, 0.2);
            color: #ffff00;
        }

        /* Top Origins/Targets */
        .top-panel {
            bottom: 20px;
            right: 20px;
            width: 350px;
            background: rgba(10, 20, 40, 0.85);
            border: 1px solid rgba(0, 200, 255, 0.3);
            border-radius: 12px;
            padding: 20px;
            backdrop-filter: blur(10px);
        }

        .top-section {
            margin-bottom: 15px;
        }

        .top-section:last-child {
            margin-bottom: 0;
        }

        .top-title {
            font-size: 12px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .top-item {
            display: flex;
            align-items: center;
            padding: 4px 0;
            font-size: 12px;
        }

        .top-rank {
            width: 20px;
            color: #666;
        }

        .top-name {
            flex: 1;
            color: #ccc;
        }

        .top-count {
            color: #00c8ff;
            font-weight: 600;
        }

        .top-bar {
            height: 3px;
            background: rgba(0, 200, 255, 0.3);
            border-radius: 2px;
            margin-top: 2px;
        }

        .top-bar-fill {
            height: 100%;
            background: #00c8ff;
            border-radius: 2px;
            transition: width 0.3s ease;
        }

        /* Connection status */
        .connection-status {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 20px;
            background: rgba(255, 0, 0, 0.8);
            border-radius: 20px;
            font-size: 12px;
            display: none;
            z-index: 100;
        }

        .connection-status.visible {
            display: block;
        }
    </style>
</head>
<body>
    <div id="globe-container"></div>

    <!-- Header -->
    <div class="overlay header">
        <div class="title">Global <span>Threat</span> Map</div>
        <div class="feed-status">
            <div class="feed-badge active" id="feed-indicator">
                <span>LIVE INTEL</span>
                <span class="feed-count" id="threat-ips-count">0</span>
                <span>IPs</span>
            </div>
            <div class="live-indicator">
                <div class="live-dot"></div>
                <span>LIVE</span>
            </div>
        </div>
    </div>

    <!-- Stats Panel -->
    <div class="overlay stats-panel">
        <div class="stats-title">Attack Statistics</div>
        <div class="stat-row">
            <span class="stat-label">Total Attacks</span>
            <span class="stat-value" id="total-attacks">0</span>
        </div>
        <div class="stat-row">
            <span class="stat-label">Attacks/Second</span>
            <span class="stat-value" id="attacks-per-sec">0</span>
        </div>
        <div class="stat-row">
            <span class="stat-label">Critical Threats</span>
            <span class="stat-value critical" id="critical-count">0</span>
        </div>
        <div class="stat-row">
            <span class="stat-label">Active Connections</span>
            <span class="stat-value" id="connections">1</span>
        </div>
    </div>

    <!-- Legend Panel -->
    <div class="overlay legend-panel">
        <div class="stats-title">Threat Types</div>
        <div id="legend-items"></div>
    </div>

    <!-- Attack Feed -->
    <div class="overlay feed-panel">
        <div class="feed-header">Live Attack Feed</div>
        <div class="feed-list" id="attack-feed"></div>
    </div>

    <!-- Top Origins/Targets -->
    <div class="overlay top-panel">
        <div class="top-section">
            <div class="top-title">Top Attack Origins</div>
            <div id="top-origins"></div>
        </div>
        <div class="top-section">
            <div class="top-title">Top Attack Targets</div>
            <div id="top-targets"></div>
        </div>
    </div>

    <!-- Connection Status -->
    <div class="connection-status" id="connection-status">
        Reconnecting to server...
    </div>

    <script>
        // Initialize globe
        const globe = Globe()
            .globeImageUrl('https://unpkg.com/three-globe@2.27.0/example/img/earth-blue-marble.jpg')
            .bumpImageUrl('https://unpkg.com/three-globe@2.27.0/example/img/earth-topology.png')
            .backgroundImageUrl('https://unpkg.com/three-globe@2.27.0/example/img/night-sky.png')
            .showAtmosphere(true)
            .atmosphereColor('#3a228a')
            .atmosphereAltitude(0.25)
            .arcsData([])
            .arcColor(d => d.color)
            .arcAltitude(d => d.altitude || 0.1)
            .arcStroke(d => d.stroke || 0.5)
            .arcDashLength(0.4)
            .arcDashGap(0.2)
            .arcDashAnimateTime(1500)
            .pointsData([])
            .pointColor(d => d.color)
            .pointAltitude(0.01)
            .pointRadius(d => d.size || 0.3)
            .pointsMerge(true)
            (document.getElementById('globe-container'));

        // Auto-rotate
        globe.controls().autoRotate = true;
        globe.controls().autoRotateSpeed = 0.3;

        // Point of view
        globe.pointOfView({ lat: 20, lng: 0, altitude: 2.5 });

        // State
        let arcs = [];
        let points = [];
        let attackFeed = [];
        let stats = {
            total_attacks: 0,
            attacks_by_type: {},
            attacks_by_origin: {},
            attacks_by_target: {}
        };
        let threatTypes = {};
        let attacksLastSecond = 0;
        let lastSecondTimestamp = Date.now();

        // WebSocket connection
        let ws;
        let reconnectTimeout;

        function connect() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${window.location.host}/ws`);

            ws.onopen = () => {
                console.log('Connected to server');
                document.getElementById('connection-status').classList.remove('visible');
            };

            ws.onmessage = (event) => {
                const message = JSON.parse(event.data);

                if (message.type === 'init') {
                    stats = message.stats;
                    threatTypes = message.threat_types;
                    initLegend();
                    message.recent_attacks.forEach(addAttack);
                    updateStats();
                    updateFeedStatus(message.feeds_status, message.stats.threat_ips_loaded);
                } else if (message.type === 'attack') {
                    addAttack(message.data);
                } else if (message.type === 'stats_update') {
                    stats = message.stats;
                    updateStats();
                    updateFeedStatus(message.feeds_status, message.stats.threat_ips_loaded);
                }
            };

            ws.onclose = () => {
                console.log('Disconnected from server');
                document.getElementById('connection-status').classList.add('visible');
                reconnectTimeout = setTimeout(connect, 3000);
            };

            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
            };
        }

        function initLegend() {
            const container = document.getElementById('legend-items');
            container.innerHTML = '';

            for (const [type, info] of Object.entries(threatTypes)) {
                const item = document.createElement('div');
                item.className = 'legend-item';
                item.innerHTML = `
                    <div class="legend-color" style="background: ${info.color}; color: ${info.color}"></div>
                    <span>${type}</span>
                    <span class="legend-count" id="legend-${type.replace(/\s+/g, '-')}">0</span>
                `;
                container.appendChild(item);
            }
        }

        function addAttack(attack) {
            // Update stats
            stats.total_attacks++;
            stats.attacks_by_type[attack.type] = (stats.attacks_by_type[attack.type] || 0) + 1;
            stats.attacks_by_origin[attack.origin.city] = (stats.attacks_by_origin[attack.origin.city] || 0) + 1;
            stats.attacks_by_target[attack.target.city] = (stats.attacks_by_target[attack.target.city] || 0) + 1;

            attacksLastSecond++;

            // Add arc
            const arc = {
                startLat: attack.origin.lat,
                startLng: attack.origin.lng,
                endLat: attack.target.lat,
                endLng: attack.target.lng,
                color: attack.color,
                altitude: 0.1 + Math.random() * 0.15,
                stroke: attack.severity === 'critical' ? 1.5 : (attack.severity === 'high' ? 1 : 0.5),
                id: attack.id
            };

            arcs.push(arc);

            // Add origin point
            const originPoint = {
                lat: attack.origin.lat,
                lng: attack.origin.lng,
                color: attack.color,
                size: 0.5,
                id: `origin-${attack.id}`
            };

            // Add target point
            const targetPoint = {
                lat: attack.target.lat,
                lng: attack.target.lng,
                color: '#ffffff',
                size: 0.3,
                id: `target-${attack.id}`
            };

            points.push(originPoint, targetPoint);

            // Remove old arcs/points (keep last 100)
            if (arcs.length > 100) {
                arcs = arcs.slice(-80);
            }
            if (points.length > 200) {
                points = points.slice(-160);
            }

            // Update globe
            globe.arcsData(arcs);
            globe.pointsData(points);

            // Add to feed
            addToFeed(attack);

            // Update UI
            updateStats();
        }

        function addToFeed(attack) {
            const feed = document.getElementById('attack-feed');
            const item = document.createElement('div');
            item.className = 'attack-item';
            item.style.setProperty('--attack-color', attack.color);

            const time = new Date(attack.timestamp).toLocaleTimeString();

            const sourceInfo = attack.source ? `<span style="color: #666; font-size: 10px;">via ${attack.source}</span>` : '';
            const malwareInfo = attack.malware ? `<br><span style="color: #ff8800; font-size: 10px;">Malware: ${attack.malware}</span>` : '';
            const ispInfo = attack.origin.isp && attack.origin.isp !== 'Unknown' ? `<br><span style="color: #666; font-size: 10px;">ISP: ${attack.origin.isp}</span>` : '';

            item.innerHTML = `
                <div class="attack-header">
                    <span class="attack-type">${attack.type}</span>
                    <span class="severity-badge severity-${attack.severity}">${attack.severity}</span>
                </div>
                <div class="attack-route">
                    <span>${attack.origin.city}, ${attack.origin.country}</span>
                    <span class="arrow">→</span>
                    <span>${attack.target.city}, ${attack.target.country}</span>
                </div>
                <div class="attack-details">
                    ${attack.origin.ip} → ${attack.target.ip}:${attack.target.port} ${sourceInfo}${malwareInfo}${ispInfo}
                </div>
            `;

            feed.insertBefore(item, feed.firstChild);

            // Keep only last 50 items
            while (feed.children.length > 50) {
                feed.removeChild(feed.lastChild);
            }
        }

        function updateStats() {
            // Total attacks
            document.getElementById('total-attacks').textContent =
                stats.total_attacks.toLocaleString();

            // Critical count
            const critical = (stats.attacks_by_type['Ransomware'] || 0) +
                           (stats.attacks_by_type['APT'] || 0);
            document.getElementById('critical-count').textContent = critical.toLocaleString();

            // Update legend counts
            for (const [type, count] of Object.entries(stats.attacks_by_type)) {
                const el = document.getElementById(`legend-${type.replace(/\s+/g, '-')}`);
                if (el) el.textContent = count.toLocaleString();
            }

            // Update top origins
            updateTopList('top-origins', stats.attacks_by_origin, 5);

            // Update top targets
            updateTopList('top-targets', stats.attacks_by_target, 5);
        }

        function updateTopList(containerId, data, limit) {
            const container = document.getElementById(containerId);
            const sorted = Object.entries(data)
                .sort((a, b) => b[1] - a[1])
                .slice(0, limit);

            const maxCount = sorted.length > 0 ? sorted[0][1] : 1;

            container.innerHTML = sorted.map(([name, count], i) => `
                <div class="top-item">
                    <span class="top-rank">${i + 1}.</span>
                    <span class="top-name">${name}</span>
                    <span class="top-count">${count.toLocaleString()}</span>
                </div>
                <div class="top-bar">
                    <div class="top-bar-fill" style="width: ${(count / maxCount) * 100}%"></div>
                </div>
            `).join('');
        }

        function updateFeedStatus(feedsStatus, totalIPs) {
            document.getElementById('threat-ips-count').textContent =
                (totalIPs || 0).toLocaleString();

            const feedIndicator = document.getElementById('feed-indicator');
            if (totalIPs > 0) {
                feedIndicator.classList.add('active');
            } else {
                feedIndicator.classList.remove('active');
            }
        }

        // Update attacks per second
        setInterval(() => {
            const now = Date.now();
            const elapsed = (now - lastSecondTimestamp) / 1000;
            const rate = Math.round(attacksLastSecond / elapsed);
            document.getElementById('attacks-per-sec').textContent = rate;
            attacksLastSecond = 0;
            lastSecondTimestamp = now;
        }, 1000);

        // Keep alive ping
        setInterval(() => {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ action: 'ping' }));
            }
        }, 30000);

        // Handle window resize
        window.addEventListener('resize', () => {
            globe.width(window.innerWidth);
            globe.height(window.innerHeight);
        });

        // Start connection
        connect();
    </script>
</body>
</html>
